---
title: Internals
---

# Internals

This page describes PyBenchx internals to help maintenance, optimizations, and extensions.

## Core components

- Bench / bench decorator
  - `Bench` keeps a list of `Case`. Calling `Bench(...).bench(...)` returns a decorator that creates a `Case` with the suite defaults.
  - `bench(**opts)` is a shorthand for the global `DEFAULT_BENCH` suite.
- Case
  - Metadata: `name`, `mode` ("func" or "context"), `n`, `repeat`, `warmup`, `args/kwargs`, `params`, `group`, `baseline`.
  - `params` generates variants via cartesian product (see `_make_variants`).
- BenchContext
  - Manual timing: `start()/end()` accumulates nanoseconds; lets you exclude per-iteration setup/teardown.
- Result
  - Aggregates per-call times (`per_call_ns`) and computes stats: `mean`, `median`, `stdev`, `min`, `max`, `p(q)`.

## Discovery and execution (CLI)

- `discover(paths)`: direct files or `**/*bench.py` under directories.
- `load_module_from_path`: imports the file with a stable module name via `_module_name_for_path` so decorators register global cases.
- `run(...)`:
  1. Performs warmup per case.
  2. Prepares variants with `_prepare_variants`:
     - Detects if `BenchContext` is actually used (fast-path).
     - Calibrates `n` per variant, honoring `--budget` and `--max-n` (or "smoke" without calibration).
  3. Runs each variant `repeat` times via `_run_single_repeat`.
  4. Filters by `-k`, formats table (`format_table`).

## Calibration

- `_calibrate_n(...)` measures progressively until approaching `target_ns` per repeat; refines with 0.8×/1.0×/1.2× candidates.
- In "context" mode there are two paths:
  - If the function really uses `BenchContext` (detected by calling once and checking `_elapsed_ns()`), measure only the region between `start()/end()`.
  - Otherwise, time the whole function (equivalent to "func" mode).

## Accuracy and robustness

- Clock: `perf_counter_ns` when available (fallback to `perf_counter`).
- GC: initial collection, disable during run and re-enable at the end (`core.run_case`); in the CLI, it tries `gc.freeze()` if present.
- Warmup: executes `_run_case_once`/invocations without timing to warm up caches/CPU.
- Statistics: `fmean` (fallback for 3.7), linear percentiles with interpolation.
- Colors: optional ANSI, TTY-detected.

## Table and baseline

- `format_table` groups by `group` and sorts according to `--sort/--desc`.
- Baseline:
  - Marked by `baseline=True` or name heuristic (contains "baseline"/"base").
  - `vs base` shows `≈ same` when relative difference ≤ 1%.

## Suggested extensions

- Multi-process/worker parallelization for independent variants.
- JSON/CSV export of metrics.
- "Regression" mode comparing to a previous snapshot.
- Per-case setup/teardown hooks.
